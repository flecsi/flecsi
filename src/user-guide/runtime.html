

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Runtime Model &mdash; FleCSI 2.1.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  
    <link rel="canonical" href="http://www.flecsi.org/src/user-guide/runtime.html"/>
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Control Model" href="control.html" />
    <link rel="prev" title="Index Spaces" href="introduction.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/flecsi.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                Version: 2.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build.html">Build &amp; Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer-guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../specialization-guide.html">Specialization Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../user-guide.html">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Index Spaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#topologies">Topologies</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Runtime Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#custom-handlers">Custom Handlers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="control.html">Control Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="data.html">Data Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="execution.html">Execution Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="flog.html">Logging Utility</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../summary.html">Internal Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../team.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../team.html#alumni">Alumni</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">FleCSI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../user-guide.html">User Guide</a> &raquo;</li>
        
      <li>Runtime Model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/src/user-guide/runtime.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="runtime-model">
<h1>Runtime Model<a class="headerlink" href="#runtime-model" title="Permalink to this headline">¶</a></h1>
<p>With the following CMake options enabled:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cmake .. -DENABLE_FLOG<span class="o">=</span>ON -DENABLE_GRAPHVIZ<span class="o">=</span>ON
</pre></div>
</div>
<p>an executable compiled with FleCSI will have several command-line options available. For example, running the <em>task</em> unit test from its location in <em>test/exec</em> with the <em>-h</em> flag, will produce the following output:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ./task -h
<span class="go">  task:</span>
<span class="go">  -h [ --help ]            Print this message and exit.</span>
<span class="go">  -t [ --tags ] [=arg(=0)] Enable the specified output tags, e.g.,</span>
<span class="go">                           --tags=tag1,tag2. Passing --tags by itself will</span>
<span class="go">                           print the available tags.</span>
<span class="go">  --control-model          Output the current control model and exit.</span>
</pre></div>
</div>
<p>The <em>–tags</em> option allows users to control logging output, e.g., by
turning on or off certain <em>guarded</em> outputs. This is a feature provided
by the FleCSI <a class="reference internal" href="flog.html#flog"><span class="std std-ref">Logging Utility</span></a>.  The <em>–control-model</em> option instructs the
executable to output a <em>.dot</em> file of the control-flow graph of the
control model. The FleCSI <a class="reference internal" href="control.html#control-model"><span class="std std-ref">Control Model</span></a> allows users to define
the structure of execution of a program. Additional options may be added
in the future, and will be documented in this guide.</p>
<hr class="docutils" />
<div class="section" id="custom-handlers">
<h2>Custom Handlers<a class="headerlink" href="#custom-handlers" title="Permalink to this headline">¶</a></h2>
<p>Because the FleCSI programming system requires, in most cases, that the
user relinquish direct control of the <em>main</em> function, we have provided
a runtime interface that allows fairly fine-grained customization of the
initialization, execution, and finalization of a program. Formally, the
runtime model is part of the <a class="reference external" href="https://github.com/laristra/cinch">Cinch build system utility</a> that was developed to support
FleCSI. The runtime interface allows users to register additional
control-point actions, i.e., initialization, and finalization, in
addition to adding new command-line options. This system allows easy
extensibility to accommodate new runtime systems that may be required by
computing architectures in the future.</p>
<p>As a simple example, consider the following code block:</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">cinch</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">boost</span><span class="o">::</span><span class="n">program_options</span><span class="p">;</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">custom_add_options</span><span class="p">(</span><span class="n">options_descriptions</span> <span class="o">&amp;</span> <span class="n">desc</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">desc</span><span class="p">.</span><span class="n">add_options</span><span class="p">()(</span><span class="s">&quot;flag,f&quot;</span><span class="p">,</span> <span class="s">&quot;Custom command-line option&quot;</span><span class="p">);</span>

<span class="p">}</span> <span class="c1">// custom_add_options</span>

<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">custom_initialization</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">,</span>
  <span class="n">variables_map</span> <span class="o">&amp;</span> <span class="n">vm</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">if</span><span class="p">(</span><span class="n">vm</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="s">&quot;flag&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Custom flag passed to program!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">// custom_initialization</span>

<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">custom_finalization</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">,</span>
  <span class="n">exit_mode_t</span> <span class="n">mode</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">// custom_finalization</span>

<span class="hll"><span class="kr">inline</span> <span class="n">runtime_handler_t</span> <span class="n">custom_handler</span> <span class="p">{</span>
</span><span class="hll">  <span class="n">custom_initialization</span><span class="p">,</span> <span class="n">custom_finalization</span><span class="p">,</span> <span class="n">custom_add_options</span>
</span><span class="hll"><span class="p">};</span>
</span>
<span class="hll"><span class="n">cinch_append_runtime_handler</span><span class="p">(</span><span class="n">custom_handler</span><span class="p">);</span>
</span></pre></div>
</td></tr></table></div>
<p>This code defines three functions:</p>
<ul class="simple">
<li><p><strong>custom_add_options</strong> <br />
This function provides a mechanism to add additional command-line
options to the main Boost options descriptor. The interface for the
options_descriptions type is documented <a class="reference external" href="https://www.boost.org/doc/libs/1_69_0/doc/html/program_options.html">here</a>.</p></li>
<li><p><strong>custom_initialization</strong> <br />
This function will be invoked during the initialization phase of the
Cinch runtime <em>main</em> function (The full code of runtime.cc is included
below.) Users can test command-line options or invoke initialization
of additional low-level runtime systems here. Non-zero returns from
this function will cause the top-level execution to exit.</p></li>
<li><p><strong>custom_finalization</strong> <br />
This function will be invoked during the shutdown phase of the Cinch
runtime <em>main</em> function. The exit mode of the top-level runtime is
passed into this function through the <em>mode</em> argument. Users can adapt
shutdown of additional low-level runtime systems based on the exit
status of the top-level execution.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The names of the custom handler functions are arbitrary, and should
reflect the user’s requirements.</p>
</div>
<p>After defining add_options, initialization, and finalization functions,
the user can create a handler object (highlighted lines), and register it
with the Cinch runtime system.</p>
<p>The following code block shows the actual <em>main</em> function implementation
of the Cinch runtime. Lines 39, 69, 71, and 81 are highlighted to
identify the call sites of user-registered handlers:</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">    :::::::: ::::::::::: ::::    :::  ::::::::  :::    :::</span>
<span class="cm">   :+:    :+:    :+:     :+:+:   :+: :+:    :+: :+:    :+:</span>
<span class="cm">   +:+           +:+     :+:+:+  +:+ +:+        +:+    +:+</span>
<span class="cm">   +#+           +#+     +#+ +:+ +#+ +#+        +#++:++#++</span>
<span class="cm">   +#+           +#+     +#+  +#+#+# +#+        +#+    +#+</span>
<span class="cm">   #+#    #+#    #+#     #+#   #+#+# #+#    #+# #+#    #+#</span>
<span class="cm">    ######## ########### ###    ####  ########  ###    ###</span>

<span class="cm">   Copyright (c) 2016, Los Alamos National Security, LLC</span>
<span class="cm">   All rights reserved.</span>
<span class="cm">                                                                              */</span>

<span class="cp">#include</span> <span class="cpf">&lt;cinch-config.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cinch/runtime.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>

<span class="cp">#if defined(CINCH_ENABLE_BOOST)</span>
  <span class="cp">#include</span> <span class="cpf">&lt;boost/program_options.hpp&gt;</span><span class="cp"></span>
  <span class="k">using</span> <span class="k">namespace</span> <span class="n">boost</span><span class="o">::</span><span class="n">program_options</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">cinch</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">runtime_t</span> <span class="o">&amp;</span> <span class="n">runtime_</span> <span class="o">=</span> <span class="n">runtime_t</span><span class="o">::</span><span class="n">instance</span><span class="p">();</span>

<span class="cp">#if defined(CINCH_ENABLE_BOOST)</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">program</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">options_description</span> <span class="n">desc</span><span class="p">(</span><span class="n">program</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">program</span><span class="p">.</span><span class="n">rfind</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>

  <span class="c1">// Add help option</span>
  <span class="n">desc</span><span class="p">.</span><span class="n">add_options</span><span class="p">()(</span><span class="s">&quot;help,h&quot;</span><span class="p">,</span> <span class="s">&quot;Print this message and exit.&quot;</span><span class="p">);</span>

  <span class="c1">// Invoke add options functions</span>
<span class="hll">  <span class="n">runtime_</span><span class="p">.</span><span class="n">add_options</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
</span>
  <span class="n">variables_map</span> <span class="n">vm</span><span class="p">;</span>
  <span class="n">parsed_options</span> <span class="n">parsed</span> <span class="o">=</span>
    <span class="n">command_line_parser</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">).</span><span class="n">options</span><span class="p">(</span><span class="n">desc</span><span class="p">).</span><span class="n">allow_unregistered</span><span class="p">().</span><span class="n">run</span><span class="p">();</span>
  <span class="n">store</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">vm</span><span class="p">);</span>

  <span class="n">notify</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>

  <span class="c1">// Gather the unregistered options, if there are any, print a help message</span>
  <span class="c1">// and die nicely.</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">unrecog_options</span> <span class="o">=</span>
    <span class="n">collect_unrecognized</span><span class="p">(</span><span class="n">parsed</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="n">include_positional</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">unrecog_options</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Unrecognized options: &quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">unrecog_options</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">unrecog_options</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="n">desc</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span> <span class="c1">// if</span>

  <span class="k">if</span><span class="p">(</span><span class="n">vm</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="s">&quot;help&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">desc</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="c1">// if</span>
<span class="cp">#endif</span>

  <span class="c1">// Invoke registered runtime initializations</span>
  <span class="k">if</span><span class="p">(</span>
<span class="cp">#if defined(CINCH_ENABLE_BOOST)</span>
<span class="hll">    <span class="n">runtime_</span><span class="p">.</span><span class="n">initialize_runtimes</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">vm</span><span class="p">)</span>
</span><span class="cp">#else</span>
<span class="hll">    <span class="n">runtime_</span><span class="p">.</span><span class="n">initialize_runtimes</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span>
</span><span class="cp">#endif</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span> <span class="c1">// if</span>

  <span class="c1">// Invoke the primary callback</span>
  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">runtime_</span><span class="p">.</span><span class="n">driver</span><span class="p">()(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

  <span class="c1">// Invoke registered runtime finalizations</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">runtime_</span><span class="p">.</span><span class="n">finalize_runtimes</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">exit_mode_t</span><span class="o">::</span><span class="n">success</span><span class="p">))</span> <span class="p">{</span>
</span>    <span class="n">std</span><span class="o">::</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span> <span class="c1">// if</span>

  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">// main</span>
</pre></div>
</td></tr></table></div>
<p>This code block shows the implementation of the registration interface:</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">    :::::::: ::::::::::: ::::    :::  ::::::::  :::    :::</span>
<span class="cm">   :+:    :+:    :+:     :+:+:   :+: :+:    :+: :+:    :+:</span>
<span class="cm">   +:+           +:+     :+:+:+  +:+ +:+        +:+    +:+</span>
<span class="cm">   +#+           +#+     +#+ +:+ +#+ +#+        +#++:++#++</span>
<span class="cm">   +#+           +#+     +#+  +#+#+# +#+        +#+    +#+</span>
<span class="cm">   #+#    #+#    #+#     #+#   #+#+# #+#    #+# #+#    #+#</span>
<span class="cm">    ######## ########### ###    ####  ########  ###    ###</span>

<span class="cm">   Copyright (c) 2016, Los Alamos National Security, LLC</span>
<span class="cm">   All rights reserved.</span>
<span class="cm">                                                                              */</span>
<span class="cp">#pragma once</span>

<span class="cp">#include</span> <span class="cpf">&lt;cinch-config.h&gt;</span><span class="cp"></span>

<span class="cp">#if defined(CINCH_ENABLE_BOOST)</span>
  <span class="cp">#include</span> <span class="cpf">&lt;boost/program_options.hpp&gt;</span><span class="cp"></span>
  <span class="k">using</span> <span class="k">namespace</span> <span class="n">boost</span><span class="o">::</span><span class="n">program_options</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#include</span> <span class="cpf">&lt;functional&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">cinch</span> <span class="p">{</span>

<span class="k">enum</span> <span class="nl">exit_mode_t</span> <span class="p">:</span> <span class="kt">size_t</span> <span class="p">{</span>
  <span class="n">success</span><span class="p">,</span>
  <span class="n">unrecognized_option</span><span class="p">,</span>
  <span class="n">help</span>
<span class="p">};</span> <span class="c1">// enum exit_mode_t</span>

<span class="cm">/*!</span>
<span class="cm">  Type to define runtime initialization and finalization handlers.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">runtime_handler_t</span> <span class="p">{</span>
<span class="cp">#if defined(CINCH_ENABLE_BOOST)</span>
  <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="p">,</span> <span class="n">variables_map</span> <span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">initialize</span><span class="p">;</span>
<span class="cp">#else</span>
  <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">initialize</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="p">,</span> <span class="n">exit_mode_t</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">finalize</span><span class="p">;</span>
<span class="cp">#if defined(CINCH_ENABLE_BOOST)</span>
  <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">options_description</span> <span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">add_options</span> <span class="o">=</span>
    <span class="p">[](</span><span class="n">options_description</span> <span class="o">&amp;</span><span class="p">){};</span>
<span class="cp">#endif</span>
<span class="p">};</span> <span class="c1">// struct runtime_handler_t</span>

<span class="cm">/*!</span>
<span class="cm">  The runtime_t type provides a stateful interface for registering and</span>
<span class="cm">  executing user-defined actions at initialization and finalization</span>
<span class="cm">  control points.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">runtime_t</span> <span class="p">{</span>

  <span class="k">static</span> <span class="n">runtime_t</span> <span class="o">&amp;</span> <span class="n">instance</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">runtime_t</span> <span class="n">r</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
  <span class="p">}</span> <span class="c1">// instance</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">program</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">program_</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">program</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">program_</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">register_driver</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="o">&gt;</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">driver_</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="c1">// register_driver</span>

  <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="o">&gt;</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">driver</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">driver_</span><span class="p">;</span>
  <span class="p">}</span> <span class="c1">// driver</span>

  <span class="cm">/*!</span>
<span class="cm">    Append the given runtime handler to the vector of handlers. Handlers</span>
<span class="cm">    will be executed in the order in which they are appended.</span>
<span class="cm">   */</span>

  <span class="kt">bool</span> <span class="n">append_runtime_handler</span><span class="p">(</span><span class="n">runtime_handler_t</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handlers_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">handler</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="c1">// register_runtime_handler</span>

  <span class="cm">/*!</span>
<span class="cm">    Access the runtime handler vector.</span>
<span class="cm">   */</span>

  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">runtime_handler_t</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">runtimes</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">handlers_</span><span class="p">;</span>
  <span class="p">}</span> <span class="c1">// runtimes</span>

  <span class="cm">/*!</span>
<span class="cm">    Invoke runtime options callbacks.</span>
<span class="cm">   */</span>

<span class="cp">#if defined(CINCH_ENABLE_BOOST)</span>
  <span class="kt">void</span> <span class="n">add_options</span><span class="p">(</span><span class="n">options_description</span> <span class="o">&amp;</span> <span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">r</span><span class="p">:</span> <span class="n">handlers_</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">r</span><span class="p">.</span><span class="n">add_options</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
    <span class="p">}</span> <span class="c1">// for</span>
  <span class="p">}</span> <span class="c1">// add_options</span>
<span class="cp">#endif </span><span class="c1">// CINCH_ENABLE_BOOST</span>

  <span class="cm">/*!</span>
<span class="cm">    Invoke runtime intiailzation callbacks.</span>
<span class="cm">   */</span>

<span class="cp">#if defined(CINCH_ENABLE_BOOST)</span>
  <span class="kt">int</span> <span class="n">initialize_runtimes</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">,</span> <span class="n">variables_map</span> <span class="o">&amp;</span> <span class="n">vm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">result</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">r</span><span class="p">:</span> <span class="n">handlers_</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">result</span> <span class="o">|=</span> <span class="n">r</span><span class="p">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">vm</span><span class="p">);</span>
    <span class="p">}</span> <span class="c1">// for</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span> <span class="c1">// initialize_runtimes</span>
<span class="cp">#else</span>
  <span class="kt">int</span> <span class="n">initialize_runtimes</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">result</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">r</span><span class="p">:</span> <span class="n">handlers_</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">result</span> <span class="o">|=</span> <span class="n">r</span><span class="p">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
    <span class="p">}</span> <span class="c1">// for</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span> <span class="c1">// initialize_runtimes</span>
<span class="cp">#endif</span>

  <span class="cm">/*!</span>
<span class="cm">    Invoke runtime finalization callbacks.</span>
<span class="cm">   */</span>

  <span class="kt">int</span> <span class="n">finalize_runtimes</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">,</span> <span class="n">exit_mode_t</span> <span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">result</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">r</span><span class="p">:</span> <span class="n">handlers_</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">result</span> <span class="o">|=</span> <span class="n">r</span><span class="p">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
    <span class="p">}</span> <span class="c1">// for</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span> <span class="c1">// finalize_runtimes</span>

<span class="k">private</span><span class="o">:</span>

  <span class="n">runtime_t</span><span class="p">()</span> <span class="p">{}</span>

  <span class="o">~</span><span class="n">runtime_t</span><span class="p">()</span> <span class="p">{}</span>

  <span class="c1">// These are deleted because this type is a singleton, i.e.,</span>
  <span class="c1">// we don&#39;t want anyone to be able to make copies or references.</span>

  <span class="n">runtime_t</span><span class="p">(</span><span class="k">const</span> <span class="n">runtime_t</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
  <span class="n">runtime_t</span> <span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">runtime_t</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
  <span class="n">runtime_t</span><span class="p">(</span><span class="n">runtime_t</span> <span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
  <span class="n">runtime_t</span> <span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">runtime_t</span> <span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">program_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">driver_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">runtime_handler_t</span><span class="o">&gt;</span> <span class="n">handlers_</span><span class="p">;</span>

<span class="p">};</span> <span class="c1">// runtime_t</span>

<span class="p">}</span> <span class="c1">// namespace cinch</span>

<span class="cm">/*!</span>
<span class="cm">  @def cinch_register_runtime_driver(driver)</span>

<span class="cm">  Register the primary runtime driver function.</span>

<span class="cm">  @param driver The primary driver with a &#39;int(int, char **)&#39; signature</span>
<span class="cm">                that should be invoked by the FleCSI runtime.</span>
<span class="cm"> */</span>

<span class="cp">#define cinch_register_runtime_driver(driver)                                  \</span>
<span class="cp">  </span><span class="cm">/* MACRO IMPLEMENTATION */</span><span class="cp">                                                   \</span>
<span class="cp">                                                                               \</span>
<span class="cp">  inline bool cinch_registered_driver_##driver =                               \</span>
<span class="cp">    cinch::runtime_t::instance().register_driver(driver)</span>

<span class="cm">/*!</span>
<span class="cm">  @def cinch_register_runtime_handler(handler)</span>

<span class="cm">  Register a runtime handler with the FleCSI runtime. Runtime handlers</span>
<span class="cm">  are invoked at fixed control points in the FleCSI control model for</span>
<span class="cm">  add options, initialization, and finalization. The finalization function</span>
<span class="cm">  has an additional argument that specifies the exit mode. Adding options</span>
<span class="cm">  is only enabled with CINCH_ENABLE_BOOST.</span>

<span class="cm">  @param handler A runtime_handler_t that references the appropriate</span>
<span class="cm">                 initialize, finalize, and add_options functions.</span>
<span class="cm"> */</span>

<span class="cp">#define cinch_append_runtime_handler(handler)                                  \</span>
<span class="cp">  </span><span class="cm">/* MACRO DEFINITION */</span><span class="cp">                                                       \</span>
<span class="cp">                                                                               \</span>
<span class="cp">  inline bool cinch_append_runtime_handler_##handler =                         \</span>
<span class="cp">    cinch::runtime_t::instance().append_runtime_handler(handler)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="control.html" class="btn btn-neutral float-right" title="Control Model" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="introduction.html" class="btn btn-neutral float-left" title="Index Spaces" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Copyright (c) 2016, Triad National Security, LLC

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    

  <style>
    /* Contents caption */
    .wy-menu-vertical>p.caption {
      color: #ffffff;
    }

    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #e3e2db;
    }
    .wy-side-nav-search>div.version, .wy-nav-top>div.version {
      color: #5f5d5f;
    }

    /* Sidebar */
    .wy-nav-side {
      background: #216897;
      color: #ffffff;
    }
  </style>


</body>
</html>